pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
level_defs={{
 name="intro",
 mapdef={0,0,8,8},
}}

--sprite flags
flag_player=0
flag_wall=1
flag_box=2
flag_tgt=3
flag_bub=4

function box_color(si)
 return si\16
end

function tgt_color(si)
 local col=si%16
 if col==8 then
  return si\16
 end
 if col==10 then
  return -1
 end
 return col-11
end

level={}
function level:new(
 lvl_index
)
 local o=setmetatable({},self)
 self.__index=self

	local lvl_def=level_defs[
	 lvl_index
	]
	o.idx=lvl_index
	o.name=lvl_def.name
 o.x0=lvl_def.mapdef[1]
 o.y0=lvl_def.mapdef[2]
 o.ncols=lvl_def.mapdef[3]
 o.nrows=lvl_def.mapdef[4]

 return o
end

function level:_sprite(mx,my)
 return mget(
  self.x0+mx,self.y0+my
 )
end

function level:_cellhasflag(
 mx,my,flag
)
 return fget(
  self:_sprite(mx,my),flag
 )
end

function level:ini_state()
 local state={}
 state.view=0
 for ix=0,self.ncols-1 do
  for iy=0,self.nrows-1 do
   if self:_cellhasflag(
    ix,iy,flag_player
   ) then
    state.px=ix
    state.py=iy
    state.psi=self:_sprite(ix,iy)
   end
  end
 end

 return state
end

function level:draw(state)
 for ix=0,self.ncols-1 do
  for iy=0,self.nrows-1 do
   local si=self:_sprite(ix,iy)
   local dsi=0
   if fget(si,flag_wall) then
    dsi=si
   elseif fget(si,flag_box) then
    local c=box_color(si)
    if c==state.view then
     dsi=si
    else
     dsi=7
    end
   elseif fget(si,flag_tgt) then
    local c=tgt_color(si)
    if c==state.view then
     dsi=si
    elseif fget(si,flag_bub) then
     dsi=(si\16)*16+14
    else
     dsi=8
    end
   elseif fget(si,flag_bub) then
    dsi=si
   end
   if dsi!=0 then
    spr(dsi,ix*8,iy*8)
   end
  end
 end

 spr(
  state.psi,
  state.px*8,
  state.py*8
 )
end
-->8
function _init()
 lvl=level:new(1)
 state=lvl:ini_state()
end

function _draw()
 cls()
 lvl:draw(state)
end

function _update()
 if btnp(‚ùé) then
  state.view=(state.view+1)%4
 end
end
__gfx__
00000000000aa000000aa00000000000000000000000000044044404044444400000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa00aaaaaa000000000000000000000000000000000404444040440044000000000099009900000000000000000000000000000000000000000
00700700022222200222222000000000000000000000000040444044440440440400004000044000090000900000000000000000000000000000000000000000
00077000a22a22aaaa22a22a00000000000000000000000000000000444444440000000000494400000000000000000000000000000000000000000000000000
00077000aaaaaaaaaaaaaaaa00000000000000000000000044044404444444440000000000444400000000000000000000000000000000000000000000000000
007007000a0000a00a0000a000000000000000000000000000000000440440440400004000044000090000900000000000000000000000000000000000000000
000000000aaaaaa00aaaaaa000000000000000000000000040444044404444040440044000000000099009900000000000000000000000000000000000000000
00000000000aa000000aa00000000000000000000000000000000000044444400000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000088888800000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000808888080880088000000000099009900440044008800880033003300110011000000000
00000000000000000000000000000000000000000000000000000000880880880800008000088000090880900408804008088080030880300108801000000000
00000000000000000000000000000000000000000000000000000000888888880000000000898800008988000089880000898800008988000089880000000000
00000000000000000000000000000000000000000000000000000000888888880000000000888800008888000088880000888800008888000088880000000000
00000000000000000000000000000000000000000000000000000000880880880800008000088000090880900408804008088080030880300108801000000000
00000000000000000000000000000000000000000000000000000000808888080880088000000000099009900440044008800880033003300110011000000000
00000000000000000000000000000000000000000000000000000000088888800000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000033333300000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000303333030330033000000000099009900440044008800880033003300110011000000000
00000000000000000000000000000000000000000000000000000000330330330300003000033000090330900403304008033080030330300103301000000000
000000000000000000000000000000000000000000000000000000003333333300000000003b3300003b3300003b3300003b3300003b3300003b330000000000
00000000000000000000000000000000000000000000000000000000333333330000000000333300003333000033330000333300003333000033330000000000
00000000000000000000000000000000000000000000000000000000330330330300003000033000090330900403304008033080030330300103301000000000
00000000000000000000000000000000000000000000000000000000303333030330033000000000099009900440044008800880033003300110011000000000
00000000000000000000000000000000000000000000000000000000033333300000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000011111100000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000101111010110011000000000099009900440044008800880033003300110011000000000
00000000000000000000000000000000000000000000000000000000110110110100001000011000090110900401104008011080030110300101101000000000
000000000000000000000000000000000000000000000000000000001111111100000000001c1100001c1100001c1100001c1100001c1100001c110000000000
00000000000000000000000000000000000000000000000000000000111111110000000000111100001111000011110000111100001111000011110000000000
00000000000000000000000000000000000000000000000000000000110110110100001000011000090110900401104008011080030110300101101000000000
00000000000000000000000000000000000000000000000000000000101111010110011000000000099009900440044008800880033003300110011000000000
00000000000000000000000000000000000000000000000000000000011111100000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010000000204081000000000000000000000000000040810181818181800000000000000000408101818181818000000000000000004081018181818180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0606060606060606000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0602000000002906000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0600000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0600001700270606000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0600002700000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0600001700281806000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0619000600182806000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
